{% extends "templates/web.html" %}
{% block page_content %}
<div class="row">
  <div class="col-md-2">
    <div class="form-group">
      <a class="btn btn-block btn-primary" data-toggle ="collapse" data-target="#newthreads">New</a>
    </div>
  </div>
  <div class="col-md-10">
    <div class="form-group">
      <div class="input-group">
        <input type="text" placeholder="Search forums" class="form-control">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button">Search</button>
        </span>
      </div>
    </div>
  </div>
</div>
<div class="row collapse" id="newthreads">
  <div class="col-md-12">
    <div class="form">
        <div class="form-group">
              <input id="new-thread-title" class="form-control" type="text" placeholder="Enter Title text for thread...">
        </div>
        <div class="form-group">
              <input id="new-thread-categories" class="form-control" type="text" placeholder="Enter Categories (Tags)">
        </div>
        <div class="form-group text-right">
          <ul class="list-inline">
            <li>
              <a class="btn btn-default" id="create-thread" data-role="save-thread" data-thread-key="btnsave">Save</a>
            </li>
            <li>
              <a class="btn btn-default" id="cancel-thread" data-toggle ="collapse" data-target="#newthreads">Cancel</a>
            </li>
          </ul>
        </div>
    </div>
  </div>
</div> 
<div class="row">
  <div class="col-md-10 hidden-sm hidden-xs">Threads</div>
  <div class="col-md-1 hidden-sm hidden-xs">Replies</div>
  <div class="col-md-1 hidden-sm hidden-xs">Activity</div>
</div>
<hr>

{% macro render_thread(thread, rowindex) %}
    <div class="row">
      <div class="col-md-10">
        <h4>{{ thread.thread_title }}</h4>
        <ul class="list-inline">
          <li class="list-inline-item">
            <div class="label label-info">FIPS</div>
          </li>
          <li class="list-inline-item">
            <div class="label label-info">FIPS 140</div>
          </li>
        </ul>
      </div>
      <div class="col-md-1 col-xs-6">
        <div class="hidden-md hidden-lg">
          <strong>Replies</strong>
        </div>
        <div>{{ thread.post_count }}</div>
      </div>
      <div class="col-md-1 col-xs-6 text-right">
        <div class="hidden-md hidden-lg">
          <strong>Activity</strong>
        </div>
        <div>{{ "3H" }}</div>
      </div>
    </div>
    <hr>    
{% endmacro %}

<div id="threads-outer">
  <div id="threads">
  <!-- {{ threads }} -->
  {% for t in threads %}
    {{ render_thread(t, 0) }}
  {% endfor %}
  </div>
</div>


<script type="text/javascript">
  frappe.ready(function(){
    function toggle_listcontrols_save_thread(threadname, editmode) {
      var th_save = $('#' + threadname + '-save-thread');
      var th_cancel = $('#' + threadname + '-cancel-thread');
        if(editmode == 1) {
          th_save.removeClass('hide'); 
          th_cancel.removeClass('hide');
        } 
        else {
          th_save.addClass('hide'); 
          th_cancel.addClass('hide');
        }
    }
      
    $('#create-thread').click(function(event){
        var title = $('#new-thread-title');
        var categories = $('#new-thread-categories');
        // console.log(title);
        // console.log(categories);
        frappe.call({
          method: "discuit.www.threads.create_thread",
          args: {
              "thread_title": title.val(),
              "thread_categories": categories.val()
          },
          freeze: true,
          freeze_message: __("Creating thread..."),
          callback: function(r){
            if(!r.exc) {
              //frappe.msgprint(__(r.message));
              //refresh_threads();

              //$('#newthread').removeClass('in'); //to collapse container.collapse();
              // title.val(''); 
              // title.addClass('hide');
              // categories.val(''); 
              // categories.addClass('hide');
              //toggle_listcontrols_save_thread(threadname, 0);
              $('#threads-outer #threads').fadeOut();
              $('#threads-outer #threads').parent().load(document.URL + ' #threads-outer #threads', function(){
                $('#threads-outer #threads').fadeIn();
              });
            } else {
              frappe.msgprint(__("Thread was not created. <br /> " + r.exc));
            }
          }
        });
      });
    // $('#threads').on('click', '[data-role="save-thread"]', function() {
    //   var threadname = $(this).attr('data-thread-key'); //Get context of Thread.
    //   var input_title = $('#' + threadname + '-new-thread-title');
    //   var input_categories = $('#' + threadname + '-new-thread-categories');

    //   frappe.call({
    //     method: "discuit.www.threads.save_thread",
    //     args: {
    //         "thread_title": input_title.val(),
    //         "thread_categories": input_categories.val()
    //     },
    //     freeze: true,
    //     freeze_message: __("Save thread..."),
    //     callback: function(r){
    //       if(!r.exc) {
    //         input_title.val(''); 
    //         input_title.addClass('hide');
    //         input_categories.val(''); 
    //         input_categories.addClass('hide');
    //         toggle_listcontrols_save_thread(threadname, 0);
          
    //         //refresh_threads();
    //         $('#threads #' + threadname + '-new-thread-title').fadeOut();
    //         $('#threads #' + threadname + '-new-thread-title').load(document.URL +  '#threads #' + threadname + '-new-thread-title', function() {
    //           $('#threads #' + threadname + '-new-thread-title').fadeIn();
    //         });
    //         //location.reload();
    //       } else {
    //         frappe.msgprint(__("Thread was not save. <br /> " + r.exc));
    //       }
    //     }
    //   }); 
    // });
  });

</script>
{% endblock %}